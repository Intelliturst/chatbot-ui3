# è™¹å®‡è·è¨“æ™ºèƒ½å®¢æœç³»çµ± - ç³»çµ±æ¶æ§‹è¨­è¨ˆæ›¸

**æ–‡ä»¶ç‰ˆæœ¬**: 1.0
**æœ€å¾Œæ›´æ–°**: 2025-10-24
**ä½œè€…**: è™¹å®‡è·è¨“é–‹ç™¼åœ˜éšŠ

---

## ğŸ“‹ ç›®éŒ„

1. [å°ˆæ¡ˆæ¦‚è¿°](#å°ˆæ¡ˆæ¦‚è¿°)
2. [æŠ€è¡“å †ç–Š](#æŠ€è¡“å †ç–Š)
3. [å¤šä»£ç†ç³»çµ±æ¶æ§‹](#å¤šä»£ç†ç³»çµ±æ¶æ§‹)
4. [è³‡æ–™æµç¨‹è¨­è¨ˆ](#è³‡æ–™æµç¨‹è¨­è¨ˆ)
5. [OpenAI APIèª¿ç”¨ç­–ç•¥](#openai-apièª¿ç”¨ç­–ç•¥)
6. [å°è©±è¨˜æ†¶æ©Ÿåˆ¶](#å°è©±è¨˜æ†¶æ©Ÿåˆ¶)
7. [éŒ¯èª¤è™•ç†èˆ‡é™ç´šç­–ç•¥](#éŒ¯èª¤è™•ç†èˆ‡é™ç´šç­–ç•¥)
8. [æ€§èƒ½å„ªåŒ–ç­–ç•¥](#æ€§èƒ½å„ªåŒ–ç­–ç•¥)

---

## å°ˆæ¡ˆæ¦‚è¿°

### æ¥­å‹™èƒŒæ™¯

è™¹å®‡è·è¨“æ˜¯æ¡ƒåœ’åœ°å€å°ˆæ¥­çš„è·æ¥­è¨“ç·´æ©Ÿæ§‹ï¼Œæä¾›æ”¿åºœè£œåŠ©çš„åœ¨è·/å¾…æ¥­è·è¨“èª²ç¨‹ã€‚ç‚ºäº†æå‡å®¢æˆ¶æœå‹™æ•ˆç‡ï¼Œéœ€è¦æ‰“é€ ä¸€å€‹æ™ºèƒ½å®¢æœç³»çµ±ï¼Œèƒ½å¤ ï¼š

- è‡ªå‹•å›ç­”å¸¸è¦‹å•é¡Œï¼ˆèª²ç¨‹è³‡è¨Šã€è£œåŠ©æ”¿ç­–ã€å ±åæµç¨‹ç­‰ï¼‰
- æ™ºèƒ½åˆ¤æ–·ç”¨æˆ¶è£œåŠ©è³‡æ ¼
- æä¾›å€‹äººåŒ–èª²ç¨‹æ¨è–¦
- å¿…è¦æ™‚è½‰æ¥çœŸäººå®¢æœ

### ç³»çµ±ç›®æ¨™

1. **æå‡æœå‹™æ•ˆç‡**ï¼šè‡ªå‹•åŒ–è™•ç†80%çš„å¸¸è¦‹å•é¡Œ
2. **é™ä½äººåŠ›æˆæœ¬**ï¼šæ¸›å°‘å®¢æœäººå“¡é‡è¤‡æ€§å·¥ä½œ
3. **æ”¹å–„ç”¨æˆ¶é«”é©—**ï¼š24/7å³æ™‚å›æ‡‰ï¼Œæ¸›å°‘ç­‰å¾…æ™‚é–“
4. **æ•¸æ“šæ”¶é›†åˆ†æ**ï¼šæ”¶é›†ç”¨æˆ¶éœ€æ±‚æ•¸æ“šï¼Œå„ªåŒ–æœå‹™

### æ ¸å¿ƒåŠŸèƒ½

- âœ… å½ˆå‡ºå¼å®¢æœè¦–çª—ï¼ˆç¶²é å³ä¸‹è§’ï¼‰
- âœ… å¤šä»£ç†æ™ºèƒ½åˆ†é¡ç³»çµ±ï¼ˆ9å€‹åˆ†é¡ï¼‰
- âœ… å°è©±è¨˜æ†¶åŠŸèƒ½ï¼ˆä¸Šä¸‹æ–‡ç†è§£ï¼‰
- âœ… èª²ç¨‹è³‡è¨ŠæŸ¥è©¢ï¼ˆç´„20é–€èª²ç¨‹ï¼‰
- âœ… è£œåŠ©è³‡æ ¼æ™ºèƒ½åˆ¤æ–·
- âœ… çœŸäººå®¢æœç„¡ç¸«è½‰æ¥
- âœ… RWDéŸ¿æ‡‰å¼è¨­è¨ˆï¼ˆDesktop/Mobileï¼‰

---

## æŠ€è¡“å †ç–Š

### å¾Œç«¯æ¡†æ¶

| æŠ€è¡“ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| **Laravel** | 8.x | ä¸»è¦Webæ¡†æ¶ |
| **Livewire** | 2.x | å‰å¾Œç«¯äº’å‹•çµ„ä»¶ |
| **PHP** | 7.4+ | ä¼ºæœå™¨ç«¯èªè¨€ |

### å‰ç«¯æŠ€è¡“

| æŠ€è¡“ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| **Tailwind CSS** | 3.x | CSSæ¡†æ¶ |
| **Alpine.js** | 3.x | è¼•é‡ç´šJSæ¡†æ¶ï¼ˆLivewireå…§å»ºï¼‰ |
| **Blade** | - | Laravelæ¨¡æ¿å¼•æ“ |

### AI/MLæœå‹™

| æœå‹™ | æ¨¡å‹ | ç”¨é€” |
|------|------|------|
| **OpenAI API** | GPT-4-Turbo | å°ˆæ¥­ä»£ç†å›ç­”ç”Ÿæˆ |
| **OpenAI API** | GPT-3.5-Turbo | åˆ†é¡LLMï¼ˆæˆæœ¬å„ªåŒ–ï¼‰ |

### è³‡æ–™å­˜å„²

| æŠ€è¡“ | ç”¨é€” | éšæ®µ |
|------|------|------|
| **JSONæ–‡ä»¶** | çŸ¥è­˜åº«å­˜å„² | éšæ®µ1ï¼šé–‹ç™¼åˆæœŸ |
| **MySQL** | èª²ç¨‹è³‡æ–™API | éšæ®µ2ï¼šAPIæ•´åˆ |
| **Session Storage** | å°è©±è¨˜æ†¶ | æ‰€æœ‰éšæ®µ |
| **MySQL RAG** | å‘é‡åŒ–æœç´¢ | éšæ®µ3ï¼šå»¶å¾ŒåŸ·è¡Œ |

### é–‹ç™¼å·¥å…·

- **Git** - ç‰ˆæœ¬æ§åˆ¶
- **Composer** - PHPä¾è³´ç®¡ç†
- **NPM** - å‰ç«¯ä¾è³´ç®¡ç†

---

## å¤šä»£ç†ç³»çµ±æ¶æ§‹

### ç³»çµ±æ¶æ§‹åœ–

```mermaid
graph TB
    User[ç”¨æˆ¶è¨Šæ¯] --> ChatbotWidget[Livewire ChatbotWidgetçµ„ä»¶]
    ChatbotWidget --> SessionManager[Session Manager<br/>å°è©±è¨˜æ†¶ç®¡ç†]
    SessionManager --> ClassificationAgent[åˆ†é¡ç¸½ä»£ç†<br/>ClassificationAgent]

    ClassificationAgent -->|åˆ†é¡åˆ¤æ–·| OpenAI_Classifier[OpenAI API<br/>GPT-3.5-Turbo]
    OpenAI_Classifier --> ClassificationAgent

    ClassificationAgent -->|0:æ‰“æ‹›å‘¼| RAG_Direct[ç›´æ¥RAGå›è¦†]
    ClassificationAgent -->|1:èª²ç¨‹å…§å®¹| CourseAgent[èª²ç¨‹å…§å®¹ä»£ç†]
    ClassificationAgent -->|2:è£œåŠ©è³‡æ ¼| SubsidyAgent[è£œåŠ©åˆ¤æ–·ä»£ç†]
    ClassificationAgent -->|4:å¸¸è¦‹å•é¡Œ| FAQAgent[å¸¸è¦‹å•é¡Œä»£ç†]
    ClassificationAgent -->|6:è¯ç¹«å®¢æœ| HumanServiceAgent[çœŸäººå®¢æœä»£ç†]
    ClassificationAgent -->|7:æƒ³è¦å ±å| EnrollmentAgent[å ±åä»£ç†]
    ClassificationAgent -->|8:ç†±é–€èª²ç¨‹| FeaturedAgent[ç†±é–€èª²ç¨‹ä»£ç†]
    ClassificationAgent -->|9:æœªçŸ¥åˆ†é¡| RAG_Direct

    CourseAgent --> RAG[RAG Service<br/>çŸ¥è­˜åº«æŸ¥è©¢]
    SubsidyAgent --> RAG
    FAQAgent --> RAG

    RAG -->|éšæ®µ1| JSON[(JSONçŸ¥è­˜åº«)]
    RAG -->|éšæ®µ2| CourseAPI[(Course API<br/>MySQL)]

    CourseAgent --> OpenAI_Agent[OpenAI API<br/>GPT-4-Turbo]
    SubsidyAgent --> OpenAI_Agent
    FAQAgent --> OpenAI_Agent
    HumanServiceAgent --> OpenAI_Agent

    OpenAI_Agent --> Response[ç”Ÿæˆå›ç­”]
    RAG_Direct --> Response

    Response --> ChatbotWidget
    ChatbotWidget --> User

    HumanServiceAgent --> NotifyAPI[å®¢æœé€šçŸ¥API]

    style ClassificationAgent fill:#4F46E5,color:#fff
    style CourseAgent fill:#10B981,color:#fff
    style SubsidyAgent fill:#10B981,color:#fff
    style FAQAgent fill:#10B981,color:#fff
    style HumanServiceAgent fill:#10B981,color:#fff
    style RAG fill:#F59E0B,color:#fff
    style OpenAI_Classifier fill:#8B5CF6,color:#fff
    style OpenAI_Agent fill:#8B5CF6,color:#fff
```

### ä»£ç†è·è²¬èªªæ˜

#### åˆ†é¡ç¸½ä»£ç† (ClassificationAgent)

**è·è²¬**ï¼š
- æ¥æ”¶ç”¨æˆ¶è¨Šæ¯
- èª¿ç”¨OpenAIé€²è¡Œæ„åœ–åˆ†é¡ï¼ˆ9å€‹åˆ†é¡ï¼‰
- ç®¡ç†å°è©±è¨˜æ†¶ï¼ˆSessionï¼‰
- è·¯ç”±åˆ°å°æ‡‰çš„å°ˆæ¥­ä»£ç†
- è™•ç†æ‰“æ‹›å‘¼/æœªçŸ¥åˆ†é¡çš„ç›´æ¥å›è¦†

**åˆ†é¡å®šç¾©**ï¼š
- **0 - æ‰“æ‹›å‘¼**ï¼šé–’èŠã€å•å€™ã€èˆ‡æœå‹™ç„¡é—œ
- **1 - èª²ç¨‹å…§å®¹**ï¼šèª²è¡¨ã€ä¸»é¡Œã€æ™‚é–“ã€æˆèª²æ–¹å¼
- **2 - è£œåŠ©è³‡æ ¼**ï¼šè£œåŠ©è¾¦æ³•ã€è³‡æ ¼ç¢ºèª
- **4 - å¸¸è¦‹å•é¡Œ**ï¼šæµç¨‹ã€è¦å®šã€è¯çµ¡æ–¹å¼
- **6 - è¯ç¹«å®¢æœ**ï¼šè½‰çœŸäººã€è«‹å‡ã€æ‰¾å°ˆäºº
- **7 - æƒ³è¦å ±å**ï¼šå ±åæ„é¡˜ã€å ±åæ–¹å¼
- **8 - ç†±é–€èª²ç¨‹**ï¼šæ¨è–¦èª²ç¨‹ã€ç²¾é¸èª²ç¨‹
- **9 - æœªçŸ¥åˆ†é¡**ï¼šç„¡æ³•æ­¸é¡çš„å•é¡Œ

#### èª²ç¨‹å…§å®¹ä»£ç† (CourseAgent)

**è·è²¬**ï¼š
- RAGæŸ¥è©¢èª²ç¨‹è³‡æ–™ï¼ˆJSONæˆ–APIï¼‰
- ç”Ÿæˆèª²ç¨‹æ¸…å–®ï¼ˆç°¡åŒ–ç‰ˆï¼‰
- å›ç­”å–®ä¸€å•é¡Œï¼ˆå¦‚ï¼šå ±åæˆªæ­¢æ™‚é–“ï¼‰
- ç”Ÿæˆé—œè¯å•é¡Œé¸é …
- æä¾›èª²ç¨‹ç¶²å€ï¼ˆå®Œæ•´è³‡è¨Šï¼‰

**å›ç­”ç­–ç•¥**ï¼š
- åˆ—å‡ºèª²ç¨‹æ¸…å–®ï¼ˆé¡¯ç¤ºé—œéµè³‡è¨Šï¼‰
- å›ç­”ç‰¹å®šå•é¡Œï¼ˆå¾è³‡æ–™æå–ï¼‰
- ä¸å±•é–‹å®Œæ•´å…§å®¹ï¼Œæä¾›ç¶²å€

#### è£œåŠ©åˆ¤æ–·ä»£ç† (SubsidyAgent)

**è·è²¬**ï¼š
- ç†è§£ç”¨æˆ¶èº«ä»½ï¼ˆåœ¨è·/å¾…æ¥­ï¼‰
- åŸ·è¡Œæ±ºç­–æ¨¹é‚è¼¯
- RAGæŸ¥è©¢è£œåŠ©è¦å‰‡
- åˆ¤æ–·è£œåŠ©æ¯”ä¾‹ï¼ˆ100%/80%ï¼‰
- ç”Ÿæˆé¸é …æŒ‰éˆ•ï¼ˆé¿å…è¼¸å…¥ï¼‰

**è£œåŠ©è¦å‰‡**ï¼š
- **åœ¨è·è€…**ï¼š80%è£œåŠ©ï¼Œéœ€å…ˆç¹³å…¨é¡å¾Œè£œåŠ©
- **å¾…æ¥­è€…**ï¼š100%è£œåŠ©ï¼ˆæˆ–ä¸€èˆ¬åœ‹æ°‘(å¾æœªåŠ éå‹ä¿)è‡ªä»˜20%ï¼‰

#### å¸¸è¦‹å•é¡Œä»£ç† (FAQAgent)

**è·è²¬**ï¼š
- RAGæŸ¥è©¢FAQè³‡æ–™åº«
- ç”Ÿæˆé—œè¯å•é¡Œé¸é …
- ç·©å­˜é—œè¯è³‡æ–™ï¼ˆé¿å…é‡è¤‡APIèª¿ç”¨ï¼‰
- æ‰¾ä¸åˆ°ç­”æ¡ˆæ™‚å‹å–„å›è¦†

#### çœŸäººå®¢æœä»£ç† (HumanServiceAgent)

**è·è²¬**ï¼š
- ç†è§£ç”¨æˆ¶éœ€æ±‚
- çµ„åˆå®¢æœé€šçŸ¥è¨Šæ¯ï¼ˆJSONæ ¼å¼ï¼‰
- èª¿ç”¨é€šçŸ¥API
- å›è¦†ç”¨æˆ¶ï¼ˆå·²é€šçŸ¥ï¼Œè«‹ç¨å€™ï¼‰

#### å ±åä»£ç† (EnrollmentAgent)

**è·è²¬**ï¼š
- æä¾›å ±åæµç¨‹èªªæ˜
- å¼•å°å¡«å¯«å ±åè¡¨å–®
- æä¾›å ±åé€£çµ

#### ç†±é–€èª²ç¨‹ä»£ç† (FeaturedAgent)

**è·è²¬**ï¼š
- æŸ¥è©¢featured=1çš„èª²ç¨‹
- æ¨è–¦ç†±é–€èª²ç¨‹
- æä¾›èª²ç¨‹æ¸…å–®

---

## è³‡æ–™æµç¨‹è¨­è¨ˆ

### å…©éšæ®µè³‡æ–™ç­–ç•¥

#### éšæ®µ1ï¼šJSONçŸ¥è­˜åº«ï¼ˆé–‹ç™¼åˆæœŸï¼‰

**ç›®çš„**ï¼šå¿«é€Ÿå•Ÿå‹•é–‹ç™¼ï¼Œä¸ä¾è³´å¾Œç«¯API

```
ç”¨æˆ¶æŸ¥è©¢
   â†“
ä»£ç†è®€å– knowledge_base/*.json
   â†“
è§£æJSONè³‡æ–™
   â†“
çµ„åˆå›ç­”
```

**å„ªé»**ï¼š
- âœ… å¿«é€Ÿé–‹ç™¼ï¼Œä¸éœ€è¦ç­‰å¾…API
- âœ… æ˜“æ–¼ä¿®æ”¹å’Œæ¸¬è©¦
- âœ… ç‰ˆæœ¬æ§åˆ¶å‹å–„

**ç¼ºé»**ï¼š
- âŒ è³‡æ–™æ›´æ–°éœ€è¦é‡æ–°éƒ¨ç½²
- âŒ ç„¡æ³•å³æ™‚åŒæ­¥èª²ç¨‹è³‡è¨Š
- âŒ ä¸é©åˆå¤§é‡è³‡æ–™

#### éšæ®µ2ï¼šCourse APIæ•´åˆï¼ˆæ­£å¼ä¸Šç·šï¼‰

**ç›®çš„**ï¼šå³æ™‚åŒæ­¥èª²ç¨‹è³‡æ–™ï¼Œå‹•æ…‹æ›´æ–°

```
ç”¨æˆ¶æŸ¥è©¢
   â†“
ä»£ç†èª¿ç”¨ CourseAPIService
   â†“
GET /api/courses
   â†“
MySQL coursesè¡¨æŸ¥è©¢
   â†“
è¿”å›JSONè³‡æ–™
   â†“
çµ„åˆå›ç­”
```

**å„ªé»**ï¼š
- âœ… å³æ™‚è³‡æ–™åŒæ­¥
- âœ… æ”¯æ´å‹•æ…‹ç¯©é¸ï¼ˆfeaturedã€typeï¼‰
- âœ… æ˜“æ–¼ç¶­è­·å’Œæ“´å±•

**é·ç§»ç­–ç•¥**ï¼š
- ä¿æŒServiceå±¤æ¥å£ä¸€è‡´
- åˆ‡æ›è³‡æ–™ä¾†æºï¼ˆJSON â†’ APIï¼‰
- ä¸å½±éŸ¿å‰ç«¯é‚è¼¯

### å°è©±æµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ¶
    participant Widget as ChatbotWidget
    participant Session as SessionManager
    participant Classifier as åˆ†é¡ä»£ç†
    participant Agent as å°ˆæ¥­ä»£ç†
    participant RAG as RAG Service
    participant OpenAI as OpenAI API

    User->>Widget: ç™¼é€è¨Šæ¯
    Widget->>Session: è¼‰å…¥å°è©±è¨˜æ†¶
    Session-->>Widget: è¿”å›æ­·å²è¨˜éŒ„

    Widget->>Classifier: è¨Šæ¯ + æ­·å²è¨˜éŒ„
    Classifier->>OpenAI: èª¿ç”¨åˆ†é¡LLM
    OpenAI-->>Classifier: è¿”å›åˆ†é¡çµæœ

    alt åˆ†é¡0æˆ–9
        Classifier->>RAG: ç›´æ¥æŸ¥è©¢çŸ¥è­˜åº«
        RAG-->>Classifier: è¿”å›é è¨­å›ç­”
        Classifier-->>Widget: è¿”å›å›ç­”
    else å…¶ä»–åˆ†é¡
        Classifier->>Agent: è·¯ç”±åˆ°å°ˆæ¥­ä»£ç†
        Agent->>RAG: æŸ¥è©¢çŸ¥è­˜åº«
        RAG-->>Agent: è¿”å›ç›¸é—œè³‡æ–™
        Agent->>OpenAI: ç”Ÿæˆå›ç­”ï¼ˆContext + Queryï¼‰
        OpenAI-->>Agent: è¿”å›ç”Ÿæˆå…§å®¹
        Agent-->>Widget: è¿”å›å›ç­” + é—œè¯å•é¡Œ
    end

    Widget->>Session: å„²å­˜å°è©±è¨˜éŒ„
    Widget->>User: é¡¯ç¤ºå›ç­”
```

---

## OpenAI APIèª¿ç”¨ç­–ç•¥

### æ¨¡å‹é¸æ“‡ç­–ç•¥

#### åˆ†é¡LLM - GPT-3.5-Turbo

**ç”¨é€”**ï¼šç”¨æˆ¶è¨Šæ¯åˆ†é¡ï¼ˆ9å€‹åˆ†é¡ï¼‰

**ç†ç”±**ï¼š
- âœ… åˆ†é¡ä»»å‹™è¼ƒç°¡å–®ï¼Œä¸éœ€è¦GPT-4
- âœ… æˆæœ¬ä½ï¼ˆ$0.0015 / 1K tokensï¼‰
- âœ… é€Ÿåº¦å¿«ï¼Œå›æ‡‰æ™‚é–“çŸ­

**Promptçµæ§‹**ï¼š
```
System: ä½ æ˜¯å°ˆé–€çš„å°è©±æ„åœ–åˆ†é¡AI
User: [ç”¨æˆ¶è¨Šæ¯ + å°è©±æ­·å²]
Output: JSONæ ¼å¼åˆ†é¡çµæœ
```

#### å°ˆæ¥­ä»£ç†LLM - GPT-4-Turbo

**ç”¨é€”**ï¼šç”Ÿæˆå°ˆæ¥­å›ç­”ï¼ˆèª²ç¨‹ã€è£œåŠ©ã€FAQç­‰ï¼‰

**ç†ç”±**ï¼š
- âœ… éœ€è¦é«˜æº–ç¢ºåº¦å’Œå°ˆæ¥­æ€§
- âœ… è¤‡é›œé‚è¼¯æ¨ç†ï¼ˆå¦‚è£œåŠ©åˆ¤æ–·ï¼‰
- âœ… è‡ªç„¶èªè¨€ç”Ÿæˆå“è³ªé«˜

**Promptçµæ§‹**ï¼š
```
System: [ä»£ç†è§’è‰²å®šç¾©]
Context: [RAGæŸ¥è©¢çµæœ]
History: [å°è©±æ­·å²]
User: [ç”¨æˆ¶å•é¡Œ]
Output: å°ˆæ¥­å›ç­” + é—œè¯å•é¡Œ
```

### æˆæœ¬å„ªåŒ–ç­–ç•¥

#### 1. ç·©å­˜æ©Ÿåˆ¶

**å¸¸è¦‹å•é¡Œç·©å­˜**ï¼š
```php
// ç·©å­˜å¸¸è¦‹å•é¡Œå›ç­”ï¼ˆ24å°æ™‚ï¼‰
$cacheKey = "faq_" . md5($question);
$answer = Cache::remember($cacheKey, 86400, function() {
    return $this->callOpenAI($question);
});
```

#### 2. é—œè¯å•é¡Œé»æ“Šé¿å…é‡è¤‡èª¿ç”¨

```php
// ç”¨æˆ¶é»æ“Šé—œè¯å•é¡Œæ™‚ï¼Œç›´æ¥å¾ç·©å­˜çš„è³‡æ–™æå–
if ($clickedRelatedQuestion) {
    // å¾Sessionä¸­æå–ä¹‹å‰RAGæŸ¥è©¢çš„å®Œæ•´è³‡æ–™
    $data = Session::get('last_rag_data');
    return $this->extractAnswer($data, $question);
}
```

#### 3. Tokené™åˆ¶

```php
// é™åˆ¶Prompté•·åº¦ï¼Œæ¸›å°‘tokenæ¶ˆè€—
$maxContextTokens = 1500; // ç´„1500è©
$truncatedContext = $this->truncateContext($ragData, $maxContextTokens);
```

#### 4. æ‰¹æ¬¡è™•ç†

```php
// èª²ç¨‹æ¸…å–®æ‰¹æ¬¡è™•ç†ï¼Œä¸€æ¬¡èª¿ç”¨è¿”å›å¤šå€‹èª²ç¨‹
$courses = $this->getCourses(['type' => 'unemployed']);
$response = $this->generateCourseList($courses); // ä¸€æ¬¡ç”Ÿæˆ
```

### APIéŒ¯èª¤è™•ç†

```php
try {
    $response = OpenAI::chat()->create([
        'model' => 'gpt-4-turbo',
        'messages' => $messages,
        'timeout' => 30,
    ]);
} catch (OpenAI\Exceptions\ErrorException $e) {
    // APIéŒ¯èª¤é™ç´šè™•ç†
    return $this->getFallbackResponse();
} catch (Exception $e) {
    // é€šç”¨éŒ¯èª¤è™•ç†
    Log::error('OpenAI API Error: ' . $e->getMessage());
    return 'æŠ±æ­‰ï¼Œç³»çµ±æš«æ™‚ç„¡æ³•å›æ‡‰ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–è¯çµ¡å®¢æœã€‚';
}
```

---

## å°è©±è¨˜æ†¶æ©Ÿåˆ¶

### Sessionçµæ§‹è¨­è¨ˆ

```php
// Sessionè³‡æ–™çµæ§‹
[
    'session_id' => 'uuid',
    'user_name' => 'ç‹å°æ˜', // å¯é¸
    'started_at' => '2025-10-24 10:30:00',
    'last_active' => '2025-10-24 10:35:00',

    'history' => [
        [
            'role' => 'user',
            'content' => 'æˆ‘æƒ³äº†è§£èª²ç¨‹è£œåŠ©',
            'timestamp' => '2025-10-24 10:30:00',
        ],
        [
            'role' => 'assistant',
            'content' => 'è«‹å•æ‚¨ç›®å‰æ˜¯åœ¨è·å·¥ä½œï¼Œé‚„æ˜¯å¾…æ¥­ä¸­å‘¢ï¼Ÿ',
            'category' => 'è£œåŠ©è³‡æ ¼',
            'timestamp' => '2025-10-24 10:30:05',
        ],
        [
            'role' => 'user',
            'content' => 'åœ¨è·',
            'timestamp' => '2025-10-24 10:30:20',
        ],
    ],

    'context' => [
        'last_category' => 'è£œåŠ©è³‡æ ¼',
        'last_response' => 'è«‹å•æ‚¨ç›®å‰æ˜¯åœ¨è·å·¥ä½œï¼Œé‚„æ˜¯å¾…æ¥­ä¸­å‘¢ï¼Ÿ',
        'user_status' => 'åœ¨è·', // è£œåŠ©åˆ¤æ–·æ™‚è¨˜éŒ„
        'selected_course' => null, // èª²ç¨‹æŸ¥è©¢æ™‚è¨˜éŒ„
        'rag_data' => [...], // æœ€å¾Œä¸€æ¬¡RAGæŸ¥è©¢çµæœï¼ˆç”¨æ–¼é—œè¯å•é¡Œï¼‰
    ],
]
```

### Sessionç®¡ç†é¡åˆ¥

```php
// src/main/php/Services/SessionManager.php

class SessionManager
{
    public function __construct()
    {
        if (!session()->has('chatbot_session')) {
            $this->initSession();
        }
    }

    public function initSession()
    {
        session([
            'chatbot_session' => [
                'session_id' => Str::uuid()->toString(),
                'started_at' => now(),
                'last_active' => now(),
                'history' => [],
                'context' => [],
            ]
        ]);
    }

    public function addMessage($role, $content, $metadata = [])
    {
        $session = session('chatbot_session');
        $session['history'][] = array_merge([
            'role' => $role,
            'content' => $content,
            'timestamp' => now()->toDateTimeString(),
        ], $metadata);

        $session['last_active'] = now();
        session(['chatbot_session' => $session]);
    }

    public function getHistory($limit = 10)
    {
        $history = session('chatbot_session.history', []);
        return array_slice($history, -$limit);
    }

    public function setContext($key, $value)
    {
        session(["chatbot_session.context.{$key}" => $value]);
    }

    public function getContext($key, $default = null)
    {
        return session("chatbot_session.context.{$key}", $default);
    }

    public function clearSession()
    {
        session()->forget('chatbot_session');
        $this->initSession();
    }
}
```

### è¨˜æ†¶ä½¿ç”¨ç¯„ä¾‹

#### ç°¡çŸ­å›è¦†ç†è§£

```php
// ç”¨æˆ¶è¼¸å…¥ï¼š"1"
$lastResponse = SessionManager::getContext('last_response');
// "è«‹å•æƒ³äº†è§£AIç¹ªç•«èª²ç¨‹çš„ 1. èª²ç¨‹æ™‚é–“ é‚„æ˜¯ 2. èª²ç¨‹åœ°é»ï¼Ÿ"

// åˆ†é¡LLMæœƒåŸºæ–¼ä¸Šä¸‹æ–‡ç†è§£ "1" æŒ‡çš„æ˜¯ "èª²ç¨‹æ™‚é–“"
$prompt = "
last_response: {$lastResponse}
user_message: 1
";
// åˆ†é¡çµæœï¼šcategory=èª²ç¨‹å…§å®¹, search="AIç¹ªç•«èª²ç¨‹æ™‚é–“"
```

#### è£œåŠ©åˆ¤æ–·ç‹€æ…‹ä¿æŒ

```php
// ç¬¬ä¸€è¼ªï¼šè©¢å•åœ¨è·/å¾…æ¥­
SessionManager::setContext('subsidy_step', 'ask_employment_status');

// ç”¨æˆ¶å›ç­”ï¼š"åœ¨è·"
SessionManager::setContext('user_status', 'åœ¨è·');
SessionManager::setContext('subsidy_step', 'ask_special_status');

// ç¬¬äºŒè¼ªï¼šè©¢å•æ˜¯å¦ç¬¦åˆç‰¹æ®Šèº«ä»½
// åŸºæ–¼ä¹‹å‰è¨˜éŒ„çš„ user_status é€²è¡Œåˆ¤æ–·
```

---

## éŒ¯èª¤è™•ç†èˆ‡é™ç´šç­–ç•¥

### éŒ¯èª¤é¡å‹èˆ‡è™•ç†

#### 1. OpenAI APIéŒ¯èª¤

**éŒ¯èª¤æƒ…å¢ƒ**ï¼š
- APIè¶…æ™‚
- APIé™æµï¼ˆRate Limitï¼‰
- APIæœå‹™ç•°å¸¸

**é™ç´šç­–ç•¥**ï¼š
```php
if ($openAIError) {
    // é™ç´šåˆ°é è¨­å›ç­”
    return $this->getFallbackResponse($category);
}
```

**é è¨­å›ç­”ç¯„ä¾‹**ï¼š
```
"æŠ±æ­‰ï¼Œç³»çµ±æš«æ™‚ç„¡æ³•å›æ‡‰æ‚¨çš„å•é¡Œã€‚

æ‚¨å¯ä»¥ï¼š
1. ç¨å¾Œå†è©¦
2. æ’¥æ‰“å®¢æœé›»è©±ï¼š03-3378075
3. åŠ å…¥LINEå®˜æ–¹å¸³è™Ÿï¼š@ouy9482x

é€ æˆä¸ä¾¿ï¼Œæ•¬è«‹è¦‹è«’ã€‚"
```

#### 2. RAGæŸ¥è©¢å¤±æ•—

**éŒ¯èª¤æƒ…å¢ƒ**ï¼š
- JSONæ–‡ä»¶è®€å–å¤±æ•—
- APIèª¿ç”¨å¤±æ•—
- æŸ¥è©¢ç„¡çµæœ

**é™ç´šç­–ç•¥**ï¼š
```php
if (empty($ragResults)) {
    return "å¾ˆæŠ±æ­‰ï¼Œæˆ‘æš«æ™‚æ‰¾ä¸åˆ°ç›¸é—œè³‡è¨Šã€‚è«‹å•æ‚¨å¯ä»¥æ›å€‹æ–¹å¼æè¿°æ‚¨çš„å•é¡Œå—ï¼Ÿæˆ–è€…ç›´æ¥è¯çµ¡æˆ‘å€‘çš„å®¢æœï¼š03-3378075";
}
```

#### 3. Sessionç•°å¸¸

**éŒ¯èª¤æƒ…å¢ƒ**ï¼š
- SessionéæœŸ
- Sessionè³‡æ–™æå£

**é™ç´šç­–ç•¥**ï¼š
```php
if (!SessionManager::isValid()) {
    SessionManager::initSession();
    return "æŠ±æ­‰ï¼Œå°è©±å·²é€¾æ™‚ã€‚è®“æˆ‘å€‘é‡æ–°é–‹å§‹å§ï¼è«‹å•æœ‰ä»€éº¼å¯ä»¥å¹«æ‚¨çš„ï¼Ÿ";
}
```

### ç›£æ§èˆ‡æ—¥èªŒ

```php
// è¨˜éŒ„é—œéµæ“ä½œ
Log::channel('chatbot')->info('User Query', [
    'session_id' => $sessionId,
    'category' => $category,
    'query' => $userMessage,
    'response_time' => $responseTime,
]);

// è¨˜éŒ„éŒ¯èª¤
Log::channel('chatbot')->error('OpenAI API Error', [
    'session_id' => $sessionId,
    'error' => $exception->getMessage(),
    'trace' => $exception->getTraceAsString(),
]);
```

---

## æ€§èƒ½å„ªåŒ–ç­–ç•¥

### 1. æ‡¶åŠ è¼‰ï¼ˆLazy Loadingï¼‰

```php
// Livewireçµ„ä»¶æ‡¶åŠ è¼‰
<div wire:init="loadMessages">
    @if ($messagesLoaded)
        <!-- è¨Šæ¯åˆ—è¡¨ -->
    @else
        <div>è¼‰å…¥ä¸­...</div>
    @endif
</div>
```

### 2. è³‡æ–™é è¼‰ï¼ˆEager Loadingï¼‰

```php
// é è¼‰å¸¸ç”¨è³‡æ–™
public function mount()
{
    $this->quickOptions = Cache::remember('quick_options', 3600, function() {
        return json_decode(file_get_contents(
            resource_path('config/chatbot/quick_options.json')
        ));
    });
}
```

### 3. éåŒæ­¥è™•ç†

```php
// è¤‡é›œæŸ¥è©¢ä½¿ç”¨Queue
dispatch(function() use ($sessionId, $query) {
    $response = $this->complexQuery($query);
    broadcast(new MessageGenerated($sessionId, $response));
});

// å‰ç«¯é¡¯ç¤ºè¼‰å…¥å‹•ç•«
```

### 4. CDNåŠ é€Ÿ

```html
<!-- éœæ…‹è³‡æºä½¿ç”¨CDN -->
<link href="{{ asset('css/chatbot.css') }}" rel="stylesheet">
<script src="{{ asset('js/chatbot.js') }}"></script>
```

---

## å®‰å…¨æ€§è€ƒé‡

### 1. è¼¸å…¥é©—è­‰

```php
// é™åˆ¶è¼¸å…¥é•·åº¦
$this->validate([
    'userInput' => 'required|string|max:500',
]);

// XSSé˜²è­·
$sanitized = htmlspecialchars($userInput, ENT_QUOTES, 'UTF-8');
```

### 2. API Keyä¿è­·

```php
// .env æ–‡ä»¶
OPENAI_API_KEY=sk-xxxx

// ä¸è¦åœ¨å‰ç«¯æš´éœ²API Key
// æ‰€æœ‰APIèª¿ç”¨éƒ½åœ¨å¾Œç«¯é€²è¡Œ
```

### 3. Rate Limiting

```php
// routes/web.php
Route::middleware('throttle:60,1')->group(function() {
    // æ¯åˆ†é˜æœ€å¤š60æ¬¡è«‹æ±‚
    Livewire::component('chatbot-widget', ChatbotWidget::class);
});
```

---

## é™„éŒ„

### ç›¸é—œæ–‡ä»¶

- [02-knowledge-base-structure.md](./02-knowledge-base-structure.md) - JSONçŸ¥è­˜åº«è¨­è¨ˆ
- [03-agent-implementation.md](./03-agent-implementation.md) - ä»£ç†å¯¦ç¾è¦ç¯„
- [05-course-api-integration.md](./05-course-api-integration.md) - Course APIå°æ¥è¨­è¨ˆ

### åƒè€ƒè³‡æ–™

- Laravel 8 å®˜æ–¹æ–‡æª”ï¼šhttps://laravel.com/docs/8.x
- Livewire 2 å®˜æ–¹æ–‡æª”ï¼šhttps://laravel-livewire.com/docs/2.x
- OpenAI API æ–‡æª”ï¼šhttps://platform.openai.com/docs

---

**æ–‡ä»¶çµæŸ**
