# 快速按鈕優化方案

> **文檔版本**: 1.0
> **建立日期**: 2025-10-26
> **測試執行者**: Claude Code
> **測試範圍**: 快速按鈕功能全面測試

---

## 📋 測試摘要

### 測試執行概況
- **測試日期**: 2025-10-26
- **測試方法**: `php artisan chatbot:test "<按鈕文字>"`
- **測試數量**: 15 個快速按鈕
- **測試範圍**: Main Menu、Course Menu、Subsidy Menu、Related Questions

### 測試結果統計
| 狀態 | 數量 | 百分比 | 說明 |
|------|------|--------|------|
| ✅ 成功 | 2 | 13.3% | 正確識別並返回預期答案 |
| ⚠️ 錯誤回覆 | 2 | 13.3% | 系統回覆但內容錯誤 |
| ❌ 無法識別 | 11 | 73.3% | 返回「無法理解」訊息 |

---

## 🔍 詳細測試結果

### 1. Main Menu (主選單) - 成功率: 25%

**配置檔案**: `resources/data/chatbot/quick_options/button_config.json`

| 按鈕名稱 | 測試結果 | 實際回覆 | 預期行為 |
|---------|---------|---------|---------|
| 課程查詢 | ❌ 失敗 | 返回「無法理解」 | 應顯示課程選單或課程列表 |
| 補助諮詢 | ❌ 失敗 | 返回「無法理解」 | 應顯示補助選單或補助資訊 |
| 報名流程 | ✅ 成功 | 找到相關FAQ並提供選項 | 符合預期 |
| 聯絡客服 | ❌ 失敗 | 返回「無法理解」 | 應顯示聯絡資訊或轉接真人客服 |

**問題分析**:
- 簡短關鍵字（2-4字）無法被 OpenAI 分類器正確識別
- 缺乏針對主選單按鈕的專用處理邏輯

---

### 2. Course Menu (課程選單) - 成功率: 0%

**配置檔案**: `resources/data/chatbot/quick_options/button_config.json`

| 按鈕名稱 | 測試結果 | 實際回覆 | 預期行為 |
|---------|---------|---------|---------|
| 待業課程 | ⚠️ 錯誤 | 顯示「補助什麼時候會撥款？」的FAQ | 應顯示待業課程列表 |
| 在職課程 | ⚠️ 錯誤 | 顯示「補助什麼時候會撥款？」的FAQ | 應顯示在職課程列表 |
| 熱門課程 | ❌ 失敗 | 返回「無法理解」 | 應顯示熱門/精選課程列表 |
| 搜尋課程 | ❌ 失敗 | 返回「無法理解」 | 應提示用戶輸入搜尋關鍵字 |

**問題分析**:
- FAQ 搜尋邏輯將「待業」和「在職」錯誤匹配到補助撥款相關內容
- 課程查詢應該路由到 `CourseAgent`，但 OpenAI 分類器未能正確分類
- 缺乏對課程類型關鍵字的特殊處理

**錯誤示例**:
```
輸入: "待業課程"
預期: 顯示待業課程列表（調用 CourseAgent）
實際: 返回 FAQ "補助什麼時候會撥款？"
```

---

### 3. Subsidy Menu (補助選單) - 成功率: 0%

**配置檔案**: `resources/data/chatbot/quick_options/button_config.json`

| 按鈕名稱 | 測試結果 | 實際回覆 | 預期行為 |
|---------|---------|---------|---------|
| 我是在職者 | ❌ 失敗 | 返回「無法理解」 | 應顯示在職者補助資格和資訊 |
| 我是待業者 | ❌ 失敗 | 返回「無法理解」 | 應顯示待業者補助資格和資訊 |
| 不確定身份 | ❌ 失敗 | 返回「無法理解」 | 應提供身份判斷引導流程 |

**問題分析**:
- 口語化的按鈕文字（"我是XX者"）無法被分類器識別
- 應該路由到 `SubsidyAgent` 但分類失敗

---

### 4. Related Questions (相關問題) - 成功率: 25%

**配置檔案**: `resources/data/chatbot/quick_options/button_config.json`

| 按鈕名稱 | 測試結果 | 實際回覆 | 預期行為 |
|---------|---------|---------|---------|
| 如何報名 | ❌ 失敗 | 返回「無法理解」 | 應顯示報名流程或相關FAQ |
| 需要準備什麼 | ✅ 成功 | 找到FAQ「需要準備什麼證明文件？」 | 符合預期 |
| 甄試流程 | ❌ 失敗 | 返回「無法理解」 | 應顯示甄試流程FAQ |
| 常見問題 | ❌ 失敗 | 返回「無法理解」 | 應顯示FAQ列表 |

---

### 5. Greeting Quick Options (打招呼快速選項)

**配置檔案**: `resources/data/chatbot/greetings/default_responses.json`

| 按鈕名稱 | 測試狀態 | 備註 |
|---------|---------|------|
| 查看課程清單 | 未測試 | 預計與「課程查詢」類似問題 |
| 補助資格確認 | 未測試 | 預計與「補助諮詢」類似問題 |
| 常見問題 | ❌ 失敗 | 已測試，返回「無法理解」 |
| 查看更多課程 | 未測試 | 預計與「課程查詢」類似問題 |
| 回到主選單 | 未測試 | 需要特殊處理邏輯 |

---

## 🚨 核心問題分析

### 問題 1: OpenAI 分類器無法正確識別短關鍵字

**影響範圍**: 大部分快速按鈕（73.3%失敗率）

**問題描述**:
- 快速按鈕通常是簡短的 2-4 字關鍵字（如：「課程查詢」、「補助諮詢」）
- 當前的 `ClassificationAgent::classifyIntent()` 使用 OpenAI 進行意圖分類
- OpenAI 分類提示詞可能不夠精準，無法正確識別這些簡短的關鍵字

**相關代碼**: `app/Services/Agents/ClassificationAgent.php` (第116-159行)

**分類提示詞當前內容**:
```
0 - 打招呼/閒聊（例如：你好、早安、謝謝）
1 - 課程內容查詢（例如：這個課程教什麼、課程內容、上課地點、報名截止時間）
2 - 課程清單查詢（例如：有哪些課程、待業課程、在職課程、課程列表）
3 - 補助資格判斷（例如：我可以申請補助嗎、補助資格、政府補助）
4 - 常見問題（例如：如何報名、需要準備什麼、上課時間）
5 - 報名流程說明（例如：怎麼報名、報名步驟、報名方式）
6 - 精選課程查詢（例如：推薦課程、熱門課程、最新課程）
7 - 課程搜尋（例如：AI課程、行銷課程、包含關鍵字的搜尋）
8 - 真人客服轉接（例如：我要找客服、轉真人、聯絡客服）
9 - 未知/其他（無法歸類的問題）
```

**失敗案例**:
- 「課程查詢」→ 應分類為 1 或 2，實際分類為 9（未知）
- 「補助諮詢」→ 應分類為 3，實際分類為 9（未知）
- 「熱門課程」→ 應分類為 6，實際分類為 9（未知）

---

### 問題 2: FAQ 搜尋邏輯錯誤匹配

**影響範圍**: Course Menu (待業課程、在職課程)

**問題描述**:
- 「待業課程」和「在職課程」被 FAQ 搜尋錯誤匹配到「補助什麼時候會撥款？」
- 這是因為 FAQ 內容中包含「待業」和「在職」關鍵字
- FAQ 搜尋使用簡單的關鍵字匹配（`stripos`），缺乏語義理解

**相關代碼**:
- `app/Services/Agents/FAQAgent.php` (第37-92行)
- `app/Services/RAGService.php` (第164-189行)

**錯誤匹配的 FAQ**:
```json
{
  "question": "補助什麼時候會撥款？",
  "answer": "在職課程補助：...\n待業課程補助：...",
  "keywords": ["撥款", "何時", "補助"]
}
```

**問題根源**:
- FAQ 答案內容包含「在職課程」和「待業課程」
- 關鍵字匹配演算法不區分問題和答案的重要性
- 缺乏優先級排序機制

---

### 問題 3: 缺乏快速按鈕專用處理邏輯

**影響範圍**: 所有快速按鈕

**問題描述**:
- 系統將快速按鈕文字視為普通用戶輸入
- 缺乏針對快速按鈕的專用路由機制
- 所有輸入都經過相同的 OpenAI 分類流程

**建議架構**:
```
用戶輸入
    ↓
是否為快速按鈕? ← 【需要添加此判斷】
    ↓ 是
快速按鈕路由表 ← 【需要建立映射表】
    ↓
直接調用對應 Agent
    ↓
返回結果
```

**當前架構**:
```
用戶輸入
    ↓
OpenAI 分類（容易失敗）
    ↓
根據分類號碼路由
    ↓
調用對應 Agent
```

---

### 問題 4: 缺乏上下文狀態管理

**影響範圍**: 互動式快速按鈕流程

**問題描述**:
- 某些快速按鈕需要上下文（如：「我是在職者」應該在補助查詢流程中）
- 當前系統未追蹤用戶在哪個對話流程中
- 獨立點擊快速按鈕時缺乏上下文會導致無法正確處理

**示例場景**:
```
用戶: 「補助諮詢」
系統: 「請問您是？」[我是在職者] [我是待業者] [不確定身份]
用戶: 點擊 [我是在職者]
預期: 系統理解這是補助查詢的後續，顯示在職者補助資訊
實際: 系統返回「無法理解」
```

---

## 💡 解決方案建議

### 方案 1: 建立快速按鈕路由表（推薦）

**優點**:
- ✅ 100% 準確率，無需依賴 AI 分類
- ✅ 響應速度快，不需調用 OpenAI API
- ✅ 易於維護和擴展
- ✅ 節省 API 成本

**實作步驟**:
1. 在 `ClassificationAgent` 添加快速按鈕映射表
2. 在 `handle()` 方法最前面添加快速按鈕檢查
3. 匹配成功直接路由到對應 Agent

**程式碼範例**:
```php
protected $quickButtonRoutes = [
    // Main Menu
    '課程查詢' => 'handleCourseMenu',
    '補助諮詢' => 'handleSubsidyMenu',
    '報名流程' => 'handleEnrollment',
    '聯絡客服' => 'handleHumanService',

    // Course Menu
    '待業課程' => ['agent' => 'course', 'type' => 'unemployed'],
    '在職課程' => ['agent' => 'course', 'type' => 'employed'],
    '熱門課程' => ['agent' => 'course', 'type' => 'featured'],
    '搜尋課程' => ['agent' => 'course', 'type' => 'search'],

    // Subsidy Menu
    '我是在職者' => ['agent' => 'subsidy', 'status' => 'employed'],
    '我是待業者' => ['agent' => 'subsidy', 'status' => 'unemployed'],
    '不確定身份' => ['agent' => 'subsidy', 'status' => 'unknown'],
];

public function handle($userMessage) {
    // 【新增】優先檢查是否為快速按鈕
    if ($route = $this->matchQuickButton($userMessage)) {
        return $this->routeQuickButton($route);
    }

    // 原有的處理邏輯...
}
```

---

### 方案 2: 優化 OpenAI 分類提示詞

**優點**:
- ✅ 維持現有架構，改動小
- ✅ 提升 AI 理解能力

**缺點**:
- ⚠️ 仍依賴 AI，無法保證 100% 準確
- ⚠️ 增加 API 成本
- ⚠️ 響應速度較慢

**實作步驟**:
1. 在分類提示詞中明確列出快速按鈕文字
2. 添加更多範例
3. 強調精確匹配

**改良後的提示詞範例**:
```
你是虹宇職訓的智能客服分類系統。

【重要】以下是常見的快速按鈕，請精確匹配：
- 「課程查詢」→ 2（課程清單查詢）
- 「補助諮詢」→ 3（補助資格判斷）
- 「待業課程」→ 2（課程清單查詢）
- 「在職課程」→ 2（課程清單查詢）
- 「熱門課程」→ 6（精選課程查詢）
... (列出所有快速按鈕)

請將用戶問題分類為以下類別之一，只需回覆數字：
0 - 打招呼/閒聊
1 - 課程內容查詢
...
```

---

### 方案 3: 優化 FAQ 搜尋演算法

**優點**:
- ✅ 提升搜尋準確度
- ✅ 減少錯誤匹配

**實作步驟**:
1. 問題標題匹配優先於答案內容匹配
2. 添加權重評分機制
3. 實作模糊匹配和語義相似度

**程式碼範例**:
```php
protected function searchFAQ($keyword) {
    $results = [];

    foreach ($faqs as $faq) {
        $score = 0;

        // 問題完全匹配 → 高分
        if (stripos($faq['question'], $keyword) !== false) {
            $score += 10;
        }

        // 關鍵字匹配 → 中分
        foreach ($faq['keywords'] as $kw) {
            if (stripos($kw, $keyword) !== false) {
                $score += 5;
            }
        }

        // 答案匹配 → 低分
        if (stripos($faq['answer'], $keyword) !== false) {
            $score += 1;
        }

        if ($score > 0) {
            $results[] = ['faq' => $faq, 'score' => $score];
        }
    }

    // 按分數排序
    usort($results, fn($a, $b) => $b['score'] <=> $a['score']);

    return array_map(fn($r) => $r['faq'], $results);
}
```

---

### 方案 4: 添加上下文狀態管理

**優點**:
- ✅ 支持多輪對話
- ✅ 改善互動式流程體驗

**實作步驟**:
1. 在 Session 中記錄當前對話狀態
2. 快速按鈕點擊時參考上下文
3. 實作狀態機管理對話流程

**程式碼範例**:
```php
// 設定對話狀態
$this->session->setContext('conversation_state', 'subsidy_inquiry');

// 檢查上下文
$state = $this->session->getContext('conversation_state');

if ($state === 'subsidy_inquiry') {
    if ($userMessage === '我是在職者') {
        // 在補助查詢上下文中，處理在職者身份
        return $this->handleEmployedSubsidy();
    }
}
```

---

## 📊 優先級建議

### 🔴 高優先級（立即修復）
1. **建立快速按鈕路由表** → 解決 73.3% 失敗率
2. **修復 FAQ 搜尋錯誤匹配** → 解決課程查詢顯示錯誤資訊

### 🟡 中優先級（近期優化）
3. **優化 OpenAI 分類提示詞** → 提升整體分類準確度
4. **優化 FAQ 搜尋演算法** → 提升搜尋品質

### 🟢 低優先級（長期改進）
5. **添加上下文狀態管理** → 支持複雜對話流程

---

## 🎯 實作順序建議

### Phase 1: 緊急修復（1-2 天）
- [ ] 實作快速按鈕路由表
- [ ] 修復課程查詢錯誤匹配問題
- [ ] 測試所有快速按鈕

### Phase 2: 優化提升（3-5 天）
- [ ] 優化 FAQ 搜尋演算法
- [ ] 改進 OpenAI 分類提示詞
- [ ] 添加單元測試

### Phase 3: 功能增強（1-2 週）
- [ ] 實作上下文狀態管理
- [ ] 添加對話流程設計
- [ ] 完善錯誤處理機制

---

## 📝 測試檢查清單

完成修復後，需要重新測試以下項目：

### Main Menu
- [ ] 課程查詢
- [ ] 補助諮詢
- [ ] 報名流程
- [ ] 聯絡客服

### Course Menu
- [ ] 待業課程
- [ ] 在職課程
- [ ] 熱門課程
- [ ] 搜尋課程

### Subsidy Menu
- [ ] 我是在職者
- [ ] 我是待業者
- [ ] 不確定身份

### Related Questions
- [ ] 如何報名
- [ ] 需要準備什麼
- [ ] 甄試流程
- [ ] 常見問題
- [ ] 報名截止時間
- [ ] 上課地點
- [ ] 課程費用
- [ ] 補助資訊
- [ ] 需要什麼文件
- [ ] 補助多少錢
- [ ] 何時撥款
- [ ] 申請流程
- [ ] 報名方式
- [ ] 錄取通知

### Greeting Quick Options
- [ ] 查看課程清單
- [ ] 補助資格確認
- [ ] 查看更多課程
- [ ] 回到主選單
- [ ] 聯絡真人客服

---

## 📚 相關文件

- **配置檔案**: `resources/data/chatbot/quick_options/button_config.json`
- **打招呼配置**: `resources/data/chatbot/greetings/default_responses.json`
- **分類代理**: `app/Services/Agents/ClassificationAgent.php`
- **FAQ 代理**: `app/Services/Agents/FAQAgent.php`
- **RAG 服務**: `app/Services/RAGService.php`

---

## 🔗 參考資料

- [測試命令] `php artisan chatbot:test "<訊息>"`
- [OpenAI API 文檔] https://platform.openai.com/docs
- [Laravel Livewire 文檔] https://laravel-livewire.com

---

**文檔結束**
